{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["file:///Users/daveonthetrack/Projects/Finote%20Loza/finote-loza-school/pages/api/admin/students/update.js"],"sourcesContent":["import { createClient } from '@supabase/supabase-js';\n\nexport default async function handler(req, res) {\n  if (req.method !== 'POST') {\n    return res.status(405).json({ error: 'Method not allowed' });\n  }\n\n  const { id, student: studentInput = {}, parent: parentInput = null } = req.body || {};\n  if (!id) return res.status(400).json({ error: 'Missing student id' });\n\n  try {\n    const url = process.env.NEXT_PUBLIC_SUPABASE_URL;\n    const key = process.env.SUPABASE_SERVICE_ROLE_KEY;\n    if (!url || !key) return res.status(500).json({ error: 'Server misconfigured' });\n    const supabase = createClient(url, key);\n\n    // Helper: treat empty strings as null so typed columns (like date) don't error\n    const normalize = (value) => {\n      if (value === '' || value === undefined) return null;\n      return value ?? null;\n    };\n\n    // Prepare student update payload (attempt extended fields, fallback to base fields)\n    const extendedStudent = {\n      first_name: normalize(studentInput.first_name),\n      middle_name: normalize(studentInput.middle_name),\n      last_name: normalize(studentInput.last_name),\n      grade_level: normalize(studentInput.grade_level),\n      homeroom: normalize(studentInput.homeroom),\n      photo_url: normalize(studentInput.photo_url),\n      date_of_birth: normalize(studentInput.date_of_birth),\n      gender: normalize(studentInput.gender),\n      email: normalize(studentInput.email),\n      phone: normalize(studentInput.phone),\n      address: normalize(studentInput.address),\n      previous_school: normalize(studentInput.previous_school),\n      previous_school_address: normalize(studentInput.previous_school_address),\n      previous_school_phone: normalize(studentInput.previous_school_phone),\n      reason_for_leaving: normalize(studentInput.reason_for_leaving),\n      special_needs: normalize(studentInput.special_needs),\n      medical_conditions: normalize(studentInput.medical_conditions),\n      extracurricular_activities: normalize(studentInput.extracurricular_activities),\n      interests: normalize(studentInput.interests),\n      goals: normalize(studentInput.goals),\n      additional_info: normalize(studentInput.additional_info),\n      emergency_contact_name: normalize(studentInput.emergency_contact_name),\n      emergency_contact_phone: normalize(studentInput.emergency_contact_phone),\n      emergency_contact_relationship: normalize(studentInput.emergency_contact_relationship),\n    };\n\n    let updateError = null;\n    let updateResult = null;\n    // Try extended update first\n    {\n      const { error } = await supabase.from('students').update(extendedStudent).eq('id', id);\n      updateError = error || null;\n    }\n    // Fallback to base fields if schema lacks columns\n    if (updateError) {\n      const baseStudent = {\n        first_name: extendedStudent.first_name,\n        last_name: extendedStudent.last_name,\n        grade_level: extendedStudent.grade_level,\n        homeroom: extendedStudent.homeroom,\n        photo_url: extendedStudent.photo_url,\n      };\n      const { error } = await supabase.from('students').update(baseStudent).eq('id', id);\n      if (error) return res.status(400).json({ error: error.message });\n      updateResult = 'base';\n    } else {\n      updateResult = 'extended';\n    }\n\n    // Parent upsert/link (best-effort)\n    let parentId = null;\n    if (parentInput && (parentInput.email || parentInput.first_name || parentInput.last_name)) {\n      // Find existing parent by email if provided\n      let parentRow = null;\n      if (parentInput.email) {\n        const { data: existingByEmail } = await supabase\n          .from('parents')\n          .select('*')\n          .eq('email', parentInput.email)\n          .maybeSingle();\n        parentRow = existingByEmail || null;\n      }\n\n      if (!parentRow) {\n        // Optionally find first linked parent for this student\n        const { data: links } = await supabase\n          .from('parent_students')\n          .select('parent_id')\n          .eq('student_id', id)\n          .limit(1);\n        if (links && links.length > 0) parentId = links[0].parent_id;\n      } else {\n        parentId = parentRow.id;\n      }\n\n      const parentPayloadExtended = {\n        first_name: parentInput.first_name ?? null,\n        last_name: parentInput.last_name ?? null,\n        email: parentInput.email ?? null,\n        phone: parentInput.phone ?? null,\n        occupation: parentInput.occupation ?? null,\n        employer: parentInput.employer ?? null,\n      };\n\n      let parentError = null;\n      if (parentId) {\n        const { error } = await supabase.from('parents').update(parentPayloadExtended).eq('id', parentId);\n        parentError = error || null;\n      } else {\n        const { data, error } = await supabase.from('parents').insert(parentPayloadExtended).select('id').single();\n        parentError = error || null;\n        if (!error) parentId = data.id;\n      }\n\n      if (parentError) {\n        // Fallback to base parent fields\n        const parentPayloadBase = {\n          first_name: parentPayloadExtended.first_name,\n          last_name: parentPayloadExtended.last_name,\n          email: parentPayloadExtended.email,\n          phone: parentPayloadExtended.phone,\n        };\n        if (parentId) {\n          await supabase.from('parents').update(parentPayloadBase).eq('id', parentId);\n        } else {\n          const { data } = await supabase.from('parents').insert(parentPayloadBase).select('id').single();\n          parentId = data?.id || parentId;\n        }\n      }\n\n      // Ensure link exists\n      if (parentId) {\n        const { data: existingLink } = await supabase\n          .from('parent_students')\n          .select('parent_id, student_id')\n          .eq('parent_id', parentId)\n          .eq('student_id', id)\n          .maybeSingle();\n        if (!existingLink) {\n          await supabase.from('parent_students').insert({ parent_id: parentId, student_id: id });\n        }\n      }\n    }\n\n    return res.status(200).json({ success: true, mode: updateResult });\n  } catch (e) {\n    return res.status(500).json({ error: 'Internal server error' });\n  }\n}\n\n\n\n\n"],"names":[],"mappings":"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"}}]
}